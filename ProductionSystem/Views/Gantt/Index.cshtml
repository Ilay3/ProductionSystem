@{
    ViewData["Title"] = "Диаграмма Ганта";
}

<div class="row">
    <div class="col-md-12">
        <h2>@ViewData["Title"]</h2>

        <!-- Фильтры -->
        <div class="card mb-3">
            <div class="card-header">
                <h5>Фильтры</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="orderFilter">Производственное задание</label>
                        <select id="orderFilter" class="form-control">
                            <option value="">Все задания</option>
                            @foreach (var order in ViewBag.Orders)
                            {
                                @if (ViewBag.SelectedOrderId == order.Id)
                                {
                                    <option value="@order.Id" selected>@order.Number - @order.Name</option>
                                }
                                else
                                {
                                    <option value="@order.Id">@order.Number - @order.Name</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="machineFilter">Станок</label>
                        <select id="machineFilter" class="form-control">
                            <option value="">Все станки</option>
                            @foreach (var machine in ViewBag.Machines)
                            {
                                @if (ViewBag.SelectedMachineId == machine.Id)
                                {
                                    <option value="@machine.Id" selected>@machine.Name</option>
                                }
                                else
                                {
                                    <option value="@machine.Id">@machine.Name</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="startDate">Дата начала</label>
                        <input type="date" id="startDate" class="form-control" />
                    </div>
                    <div class="col-md-2">
                        <label for="endDate">Дата окончания</label>
                        <input type="date" id="endDate" class="form-control" />
                    </div>
                    <div class="col-md-2">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-primary btn-block" onclick="updateGantt()">
                            Обновить
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Легенда -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-12">
                        <strong>Легенда:</strong>
                        <span class="badge bg-secondary ms-2">Готов к запуску</span>
                        <span class="badge bg-primary ms-2">В работе</span>
                        <span class="badge bg-warning ms-2">На паузе</span>
                        <span class="badge bg-success ms-2">Завершен</span>
                        <span class="badge bg-warning ms-2" style="background-color: #ffa500 !important;">Переналадка</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Диаграмма -->
        <div class="card">
            <div class="card-body">
                <div id="gantt_chart" style="height: 600px; width: 100%;"></div>
            </div>
        </div>

        <!-- Загрузка станков -->
        <div class="card mt-3">
            <div class="card-header">
                <h5>Загрузка станков</h5>
            </div>
            <div class="card-body">
                <div id="utilization_chart" style="height: 400px; width: 100%;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Глобальная переменная для хранения данных
    let ganttDataGlobal = [];

    // ИСПРАВЛЕНИЕ: загружаем правильные пакеты Google Charts
    google.charts.load('current', {
        'packages': ['gantt', 'corechart'],
        'language': 'ru'  // Русский язык для Google Charts
    });
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {
        updateGantt();
    }

    function updateGantt() {
        const orderId = document.getElementById('orderFilter').value;
        const machineId = document.getElementById('machineFilter').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        // Показываем индикатор загрузки
        document.getElementById('gantt_chart').innerHTML = '<div class="text-center"><i class="fa fa-spinner fa-spin fa-3x"></i><p>Загрузка данных...</p></div>';

        const params = new URLSearchParams();
        if (orderId) params.append('orderId', orderId);
        if (machineId) params.append('machineId', machineId);
        if (startDate) params.append('startDate', startDate);
        if (endDate) params.append('endDate', endDate);

        fetch(`/Gantt/GetGanttData?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Полученные данные:', data);
                ganttDataGlobal = data;

                const dataTable = new google.visualization.DataTable();

                // Определяем колонки с русскими названиями
                dataTable.addColumn('string', 'ID задачи');
                dataTable.addColumn('string', 'Название задачи');
                dataTable.addColumn('string', 'Ресурс');
                dataTable.addColumn('date', 'Дата начала');
                dataTable.addColumn('date', 'Дата окончания');
                dataTable.addColumn('number', 'Длительность');
                dataTable.addColumn('number', 'Процент выполнения');
                dataTable.addColumn('string', 'Зависимости');

                // Добавляем данные
                data.forEach(item => {
                    const startDate = item.actualStart ? new Date(item.actualStart) :
                                     (item.start ? new Date(item.start) : new Date());
                    const endDate = item.actualEnd ? new Date(item.actualEnd) :
                                   (item.end ? new Date(item.end) : new Date(startDate.getTime() + item.duration));

                    dataTable.addRow([
                        item.taskId,
                        item.taskName,
                        item.resource,
                        startDate,
                        endDate,
                        item.duration,
                        item.percentComplete,
                        item.dependencies || ""
                    ]);
                });

                // Опции диаграммы с русскими подписями
                const options = {
                    height: 600,
                    width: '100%',
                    gantt: {
                        trackHeight: 30,
                        barHeight: 20,
                        criticalPathEnabled: false,
                        innerGridHorizontalStroke: '#eeeeee',
                        innerGridVerticalStroke: '#eeeeee',
                        arrow: {
                            angle: 0,
                            length: 0,
                            spaceAfter: 0
                        },
                        labelStyle: {
                            fontName: 'Arial',
                            fontSize: 11,
                            color: '#333'
                        },
                        dependenciesEnabled: false
                    }
                };

                const chart = new google.visualization.Gantt(document.getElementById('gantt_chart'));

                // Обработчик клика
                google.visualization.events.addListener(chart, 'select', function () {
                    try {
                        const selection = chart.getSelection();
                        if (selection.length > 0) {
                            const row = selection[0].row;
                            if (ganttDataGlobal && ganttDataGlobal[row]) {
                                const item = ganttDataGlobal[row];
                                showStageDetails(item);
                            }
                        }
                    } catch (error) {
                        console.error('Ошибка обработки клика:', error);
                    }
                });

                chart.draw(dataTable, options);
            })
            .catch(error => {
                console.error('Error loading Gantt data:', error);
                document.getElementById('gantt_chart').innerHTML = `<div class="alert alert-danger">Ошибка загрузки данных: ${error.message}</div>`;
            });

        // Загружаем данные о загрузке станков
        loadMachineUtilization();
    }

    function loadMachineUtilization() {
        const machineId = document.getElementById('machineFilter').value;
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        const params = new URLSearchParams();
        if (machineId) params.append('machineId', machineId);
        if (startDate) params.append('startDate', startDate);
        if (endDate) params.append('endDate', endDate);

        fetch(`/Gantt/GetMachineUtilization?${params.toString()}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Данные загрузки станков:', data);

                const dataTable = new google.visualization.DataTable();
                dataTable.addColumn('string', 'Станок');
                dataTable.addColumn('number', 'Производство (ч)');
                dataTable.addColumn('number', 'Переналадка (ч)');

                data.forEach(item => {
                    dataTable.addRow([
                        item.machine,
                        parseFloat(item.productionTime.toFixed(2)),
                        parseFloat(item.changeoverTime.toFixed(2))
                    ]);
                });

                const options = {
                    title: 'Загрузка станков (часы)',
                    titleTextStyle: { fontSize: 16 },
                    chartArea: { width: '80%', height: '80%' },
                    hAxis: { title: 'Время (часы)', minValue: 0 },
                    vAxis: { title: 'Станки' },
                    isStacked: true,
                    series: {
                        0: { color: '#28a745' },  // Производство - зеленый
                        1: { color: '#ffc107' }   // Переналадка - желтый
                    },
                    backgroundColor: 'white'
                };

                // ИСПРАВЛЕНИЕ: используем правильный конструктор
                const chart = new google.visualization.ColumnChart(document.getElementById('utilization_chart'));
                chart.draw(dataTable, options);
            })
            .catch(error => {
                console.error('Error loading utilization data:', error);
                document.getElementById('utilization_chart').innerHTML = `<div class="alert alert-danger">Ошибка загрузки данных о загрузке: ${error.message}</div>`;
            });
    }

    function showStageDetails(item) {
        if (item && item.stageId && item.stageId > 0) {
            window.open(`/RouteStages/Details/${item.stageId}`, '_blank');
        } else {
            console.error('Нет stageId в элементе:', item);
            alert('Ошибка: не удается открыть детали этапа');
        }
    }

    // Инициализация дат
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date();
        const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        const oneWeekLater = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);

        document.getElementById('startDate').value = oneWeekAgo.toISOString().split('T')[0];
        document.getElementById('endDate').value = oneWeekLater.toISOString().split('T')[0];
    });
</script>